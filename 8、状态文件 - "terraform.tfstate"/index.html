<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>8、状态文件   "terraform.tfstate" - Terraform at AWS Guide</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "8\u3001\u72b6\u6001\u6587\u4ef6   \"terraform.tfstate\"";
        var mkdocs_page_input_path = "8\u3001\u72b6\u6001\u6587\u4ef6 - \"terraform.tfstate\".md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Terraform at AWS Guide
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Terraform at AWS Guide</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>8、状态文件   "terraform.tfstate"</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="-terraformtfstate">状态文件 - terraform.tfstate<a class="headerlink" href="#-terraformtfstate" title="Permanent link">&para;</a></h1>
<h2 id="_1">知识点<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>Terraform 的状态文件 - terraform.tfstate</li>
</ul>
<h2 id="_2">官网<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>https://www.terraform.io/language/state</p>
<h2 id="_3">说明讲解<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="tfstate">tfstate 是什么？<a class="headerlink" href="#tfstate" title="Permanent link">&para;</a></h3>
<p>.tfstate 文件是 Terraform 管理现有资源状态的文件。</p>
<h3 id="tfstate_1">为什么要有 tfstate<a class="headerlink" href="#tfstate_1" title="Permanent link">&para;</a></h3>
<p>每当执行 <code>terraform plan</code> 的时候， Terraform 都会为我们比较本地资源的变化和服务器资源的不同。</p>
<p>这点和 CloudFormation 不一样， CloudFormation 是存在云端的。</p>
<p>大家请想一个问题, 为什么我们可以通过 <code>terraform apply</code> 建立出的 EC2, 马上可以通过 <code>terraform destroy</code> 进行销毁呢？ </p>
<p>Terraform 是怎么知道该销毁哪台 EC2 的? 会不会将云中的其他 EC2 销毁呢？ </p>
<p>如果没有状态管理， 这就很危险。</p>
<h3 id="terraformtfstate">terraform.tfstate文件的作用<a class="headerlink" href="#terraformtfstate" title="Permanent link">&para;</a></h3>
<ul>
<li><em>terraform.tfstate</em>记录了<strong>当前tf管理的资源的状态</strong>。</li>
<li>如果我们在此之前执行了<code>terraform destroy</code> 命令，把资源都销毁了，那么<em>terraform.tfstate</em>文件里面是看不到任何resources信息的，因为该文件记录的是当前的tf管理资源的状态。</li>
<li>但是，Terraform为我们提供了上一次通过tf管理资源的<em>terraform.tfstate.backup</em>文件。</li>
</ul>
<h3 id="tfstate_2">一起来看一下 tfstate 文件样例<a class="headerlink" href="#tfstate_2" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>terraform.tfstate
</code></pre></div>

<p><em>terraform.tfstate</em></p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">  </span><span class="c1">// 采用版本</span>
<span class="w">  </span><span class="nt">&quot;terraform_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.1.4&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="c1">// 运行次数</span>
<span class="w">  </span><span class="nt">&quot;serial&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span>
<span class="w">  </span><span class="c1">// 项目唯一ID。如果本地用tf管理多个项目，但是因为ID是唯一的，这会确保不同的tf不会影响到云端的同一个资源</span>
<span class="w">  </span><span class="nt">&quot;lineage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a81e9642-ae12-9afc-ab52-1bb1ca1d5b66&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;outputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">  </span><span class="nt">&quot;resources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;managed&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="c1">// 资源类型</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aws_instance&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="c1">// 资源名称(TF使用)</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;myweb_server2&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;provider&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;provider[\&quot;registry.terraform.io/hashicorp/aws\&quot;]&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;instances&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;schema_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;attributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// AMI-ID</span>
<span class="w">            </span><span class="nt">&quot;ami&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ami-0218d08a1f9dac831&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="c1">// EC2 ARN</span>
<span class="w">            </span><span class="nt">&quot;arn&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:ec2:ap-northeast-1:168571836196:instance/i-06f67dc122136c534&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="c1">// EC2 各种属性设置 ...</span>
<span class="w">            </span><span class="nt">&quot;associate_public_ip_address&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;availability_zone&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ap-northeast-1a&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;capacity_reservation_specification&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;capacity_reservation_preference&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;open&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;capacity_reservation_target&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;cpu_core_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;cpu_threads_per_core&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;credit_specification&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;cpu_credits&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;standard&quot;</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;disable_api_termination&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;ebs_block_device&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nt">&quot;ebs_optimized&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;enclave_options&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;ephemeral_block_device&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nt">&quot;get_password_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;hibernation&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;host_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;iam_instance_profile&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;i-06f67dc122136c534&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;instance_initiated_shutdown_behavior&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;stop&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;instance_state&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;running&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;instance_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;t2.micro&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;ipv6_address_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;ipv6_addresses&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nt">&quot;key_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;launch_template&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nt">&quot;metadata_options&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;http_endpoint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;enabled&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;http_put_response_hop_limit&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;http_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;optional&quot;</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;monitoring&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;network_interface&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nt">&quot;outpost_arn&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;password_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;placement_group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;placement_partition_number&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;primary_network_interface_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eni-04777e6b3d682c7e8&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;private_dns&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ip-172-31-45-191.ap-northeast-1.compute.internal&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;private_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;172.31.45.191&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;public_dns&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ec2-13-231-129-70.ap-northeast-1.compute.amazonaws.com&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;public_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;13.231.129.70&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;root_block_device&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;delete_on_termination&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;device_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/dev/xvda&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;encrypted&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;iops&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;kms_key_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">                </span><span class="nt">&quot;throughput&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;volume_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vol-013199e72886ccebd&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;volume_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;volume_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gp2&quot;</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;secondary_private_ips&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nt">&quot;security_groups&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="s2">&quot;default&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;source_dest_check&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;subnet_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;subnet-0647f7f6ae12f3d59&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;Name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;learnaws-ec2-from-terraform2&quot;</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;tags_all&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;Name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;learnaws-ec2-from-terraform2&quot;</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;tenancy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;timeouts&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;user_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4d496b03906764122c3ddb6f8bba0bddb432ec11&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;user_data_base64&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;volume_tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;vpc_security_group_ids&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="s2">&quot;sg-0e114289b84c9418a&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nt">&quot;sensitive_attributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">          </span><span class="nt">&quot;private&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6MTIwMDAwMDAwMDAwMCwidXBkYXRlIjo2MDAwMDAwMDAwMDB9LCJzY2hlbWFfdmVyc2lvbiI6IjEifQ==&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_4">强烈建议<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<ul>
<li>在进行源代码管理时，务必把<em>terraform.tfstate</em>文件也管理进去。</li>
<li>因为一旦<em>terraform.tfstate</em>文件丢失，tf就不知道该管理哪些资源</li>
<li><em>terraform.tfstate</em>虽然是自动生成自动维护，但确是使用tf管理云资源最最重要的文件，一定不可以丢失。</li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
